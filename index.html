<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Worm RNG: Neural App</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --comun: #7f8c8d; --raro: #00d2ff; --epico: #a29bfe; 
            --legendario: #ffeaa7; --mitico: #ff7675; --secreto: #6c5ce7;
            --neon: #00ffcc; --dark: #0a0a0b;
        }

        body { 
            background: var(--dark); color: white; font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* --- FONDO CYBERPUNK --- */
        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(transparent 0%, rgba(0, 255, 204, 0.05) 50%, transparent 100%),
                        linear-gradient(90deg, transparent 0%, rgba(0, 255, 204, 0.05) 50%, transparent 100%);
            background-size: 40px 40px;
            perspective: 1000px;
        }

        /* --- PANTALLA DE INICIO MEJORADA --- */
        #start-screen {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 5px solid #111;
        }
        .scanline {
            width: 100%; height: 2px; background: rgba(0, 255, 204, 0.3);
            position: absolute; animation: scan 3s linear infinite;
        }
        @keyframes scan { from { top: 0; } to { top: 100%; } }

        .loading-bar {
            width: 200px; height: 10px; border: 2px solid var(--neon);
            margin-top: 20px; position: relative;
        }
        .loading-fill {
            height: 100%; width: 0%; background: var(--neon);
            animation: fill 2s forwards;
        }
        @keyframes fill { to { width: 100%; } }

        /* --- CONTENEDORES --- */
        .game-container {
            width: 90%; max-width: 400px; padding: 15px;
            background: rgba(10, 10, 11, 0.9); border: 2px solid #222;
            border-radius: 20px; box-shadow: 0 0 30px rgba(0,0,0,1);
            margin-top: 10px; position: relative;
        }

        .stat-bar {
            display: flex; justify-content: space-between; font-size: 0.5rem;
            background: #000; padding: 10px; border-radius: 10px; border: 1px solid #333;
            margin-bottom: 10px; color: var(--neon);
        }

        /* --- RULETA OPTIMIZADA --- */
        .roulette-wrapper {
            position: relative; width: 100%; height: 140px; background: #000;
            border: 2px solid #333; overflow: hidden; margin: 10px 0;
            border-radius: 10px;
        }
        .marker {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; 
            background: var(--neon); z-index: 10; transform: translateX(-50%);
            box-shadow: 0 0 15px var(--neon);
        }
        #roulette-strip {
            display: flex; position: absolute; left: 0; top: 0; height: 100%;
            will-change: transform; /* Optimizaci√≥n de hardware */
        }
        .item {
            min-width: 120px; height: 100%; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.35rem;
            border-right: 1px solid #111;
        }

        /* --- BOTONES Y UPGRADES --- */
        .btn-roll {
            width: 100%; padding: 15px; background: var(--neon); color: #000;
            font-family: 'Press Start 2P'; font-size: 0.9rem; border: none;
            border-radius: 10px; cursor: pointer; transition: 0.2s;
            box-shadow: 0 5px 0 #00886a; margin-bottom: 10px;
        }
        .btn-roll:active { transform: translateY(3px); box-shadow: 0 2px 0 #00886a; }
        .btn-roll:disabled { background: #333; box-shadow: none; color: #666; }

        .upgrade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .card {
            background: #151517; border: 1px solid #333; padding: 10px;
            border-radius: 10px; text-align: center; font-size: 0.35rem;
        }

        /* --- DISENOS DE GUSANOS SVG --- */
        .worm-svg { width: 80px; height: 40px; }
        
        .base-slot {
            background: #000; border: 2px dashed #333; height: 70px;
            border-radius: 10px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; font-size: 0.35rem; flex: 1;
        }

        #side-btn {
            position: fixed; top: 20px; right: 20px; padding: 10px;
            background: #000; border: 2px solid var(--neon); color: var(--neon);
            border-radius: 10px; font-size: 0.8rem; z-index: 100;
        }

        #god-timer {
            display: none; background: gold; color: #000; padding: 5px;
            font-size: 0.4rem; text-align: center; border-radius: 5px; margin-bottom: 10px;
        }
    </style>
</head>
<body>

    <div class="grid-bg"></div>
    <div id="side-btn" onclick="toggleModal()">üìÅ</div>

    <div id="start-screen" onclick="startGame()">
        <div class="scanline"></div>
        <h1 style="color:var(--neon); font-size: 1.2rem; text-shadow: 0 0 10px var(--neon);">NEURAL LINK</h1>
        <div class="loading-bar"><div class="loading-fill"></div></div>
        <p style="font-size: 0.4rem; margin-top: 20px; color: #444;">TAP TO CONNECT</p>
    </div>

    <div class="game-container">
        <div id="god-timer">CRITICAL LUCK: <span id="time-left">120</span>s</div>
        
        <div class="stat-bar">
            <span>CREDITS: <span id="coins" style="color:white">100</span></span>
            <span>DATA: <span id="mps">0</span>/s</span>
        </div>

        <div class="roulette-wrapper">
            <div class="marker"></div>
            <div id="roulette-strip"></div>
        </div>

        <button class="btn-roll" id="roll-btn" onclick="startRoll()">EXECUTE ROLL (-10)</button>

        <div class="upgrade-grid">
            <div class="card" onclick="upgradeSpeed()">
                SPEED<br><span id="speed-val">3.0</span>s
                <div style="color:gold; margin-top:5px;" id="speed-cost">100</div>
            </div>
            <div class="card" onclick="upgradeLuck()">
                LUCK<br>x<span id="luck-val">1.0</span>
                <div style="color:gold; margin-top:5px;" id="luck-cost">1000</div>
            </div>
        </div>

        <div style="display:flex; border:1px solid #333; background:#000; margin:10px 0; border-radius:5px;">
            <input type="text" id="code-in" placeholder="ENTER_CODE" style="flex:1; background:none; border:none; color:var(--neon); padding:8px; font-family:'Press Start 2P'; font-size:0.4rem; outline:none;">
            <button onclick="useCode()" style="background:var(--neon); border:none; padding:5px 10px; font-family:'Press Start 2P'; font-size:0.4rem;">OK</button>
        </div>

        <div style="display:flex; gap:5px;">
            <div class="base-slot" id="slot-0" onclick="removeWorm(0)">[EMPTY]</div>
            <div class="base-slot" id="slot-1" onclick="removeWorm(1)">[EMPTY]</div>
            <div class="base-slot" id="slot-2" onclick="removeWorm(2)">[EMPTY]</div>
        </div>
    </div>

    <div id="modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9000; display:none; flex-direction:column; padding:20px;">
        <div style="text-align:right; color:red; margin-bottom:20px;" onclick="toggleModal()">[TERMINATE]</div>
        <div id="catalog-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; overflow-y:auto;"></div>
    </div>

<script>
    const RAREZAS = {
        COMUN: { color: "#7f8c8d", mult: 1, nombres: ["Tierra", "Lodo", "Raiz", "Pasto"] },
        RARO: { color: "#00d2ff", mult: 4, nombres: ["Neon", "Fuego", "Acido", "Vapor"] },
        EPICO: { color: "#a29bfe", mult: 15, nombres: ["Aura", "Nebula", "Plasma"] },
        LEGENDARIO: { color: "#ffeaa7", mult: 60, nombres: ["Oro", "Solar", "Gema"] },
        MITICO: { color: "#ff7675", mult: 200, nombres: ["Vacio", "Caos"] },
        SECRETO: { color: "#6c5ce7", mult: 1000, nombres: ["Putolauate"] }
    };

    let TODOS = [];
    Object.keys(RAREZAS).forEach(rar => {
        RAREZAS[rar].nombres.forEach(nom => {
            TODOS.push({ nombre: nom, rareza: rar, color: RAREZAS[rar].color, income: RAREZAS[rar].mult, id: TODOS.length });
        });
    });

    let coins = 100, inventory = {}, discovered = {}, bases = [null, null, null];
    let rollSpeed = 3000, speedCost = 100, luckMult = 1, luckCost = 1000;
    let audioCtx, godMode = false;

    // --- MOTOR VISUAL DE GUSANOS ---
    function getWormSVG(worm) {
        const c = worm.color;
        let extra = "";
        
        if(worm.rareza === "RARO") extra = `<path d="M10,10 L15,0 L20,10" fill="${c}" />`;
        if(worm.rareza === "EPICO") extra = `<circle cx="60" cy="20" r="10" fill="${c}" opacity="0.3" />`;
        if(worm.rareza === "LEGENDARIO" || worm.rareza === "MITICO") {
            extra = `<circle cx="40" cy="20" r="15" stroke="${c}" fill="none" stroke-width="2"><animate attributeName="r" values="10;20;10" dur="1s" repeatCount="indefinite" /></circle>`;
        }

        return `
        <svg class="worm-svg" viewBox="0 0 80 40">
            <filter id="glow${worm.id}"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            <path d="M10,25 Q25,10 40,25 T70,25" stroke="${c}" stroke-width="6" fill="none" stroke-linecap="round" filter="url(#glow${worm.id})" />
            ${extra}
            <circle cx="70" cy="22" r="2" fill="white" />
        </svg>`;
    }

    // --- PERSISTENCIA ---
    function save() {
        const data = { coins, inventory, discovered, rollSpeed, speedCost, luckMult, luckCost, basesIds: bases.map(b => b?b.id:null) };
        localStorage.setItem('worm_data_v3', JSON.stringify(data));
    }

    function load() {
        const saved = localStorage.getItem('worm_data_v3');
        if(saved) {
            const d = JSON.parse(saved);
            coins = d.coins; inventory = d.inventory; discovered = d.discovered;
            rollSpeed = d.rollSpeed; speedCost = d.speedCost; luckMult = d.luckMult; luckCost = d.luckCost;
            if(d.basesIds) bases = d.basesIds.map(id => id !== null ? TODOS.find(w => w.id === id) : null);
        }
        updateUI(); updateBasesUI();
    }

    function startGame() {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        document.getElementById('start-screen').style.display = 'none';
        load();
    }

    // --- RULETA OPTIMIZADA ---
    function startRoll() {
        if(coins < 10) return;
        coins -= 10; updateUI();
        
        const btn = document.getElementById('roll-btn');
        const strip = document.getElementById('roulette-strip');
        btn.disabled = true;

        const count = 30;
        const winnerIdx = 25;
        const itemWidth = 120;
        
        strip.style.transition = 'none';
        strip.style.transform = 'translateX(0)';
        
        let html = "";
        let pool = [];
        for(let i=0; i<count; i++) {
            let w = getRNGWorm();
            pool.push(w);
            html += `<div class="item">${getWormSVG(w)}<b style="color:${w.color}">${w.nombre}</b></div>`;
        }
        strip.innerHTML = html;

        setTimeout(() => {
            const offset = -(winnerIdx * itemWidth) + (strip.parentElement.offsetWidth / 2) - (itemWidth / 2);
            strip.style.transition = `transform ${rollSpeed}ms cubic-bezier(0.15, 0, 0.15, 1)`;
            strip.style.transform = `translateX(${offset}px)`;
            
            setTimeout(() => {
                finalizarRoll(pool[winnerIdx]);
                btn.disabled = false;
            }, rollSpeed);
        }, 50);
    }

    function getRNGWorm() {
        const r = Math.random() * 100 * (1/luckMult);
        if(r < 0.1) return getRandomByRareza("SECRETO");
        if(r < 0.8) return getRandomByRareza("MITICO");
        if(r < 4) return getRandomByRareza("LEGENDARIO");
        if(r < 15) return getRandomByRareza("EPICO");
        if(r < 40) return getRandomByRareza("RARO");
        return getRandomByRareza("COMUN");
    }

    function getRandomByRareza(rar) {
        let p = TODOS.filter(w => w.rareza === rar);
        return p[Math.floor(Math.random() * p.length)];
    }

    function finalizarRoll(worm) {
        discovered[worm.id] = true;
        inventory[worm.id] = (inventory[worm.id] || 0) + 1;
        save(); updateUI();
    }

    function upgradeSpeed() { if(coins >= speedCost) { coins -= speedCost; rollSpeed = Math.max(400, rollSpeed - 300); speedCost *= 2; save(); updateUI(); } }
    function upgradeLuck() { if(coins >= luckCost) { coins -= luckCost; luckMult += 0.5; luckCost *= 2; save(); updateUI(); } }

    function useCode() {
        const val = document.getElementById('code-in').value.toUpperCase();
        if(val === "OPWORM99" && !godMode) {
            coins += 100000; godMode = true;
            let oldLuck = luckMult; luckMult = 99;
            document.getElementById('god-timer').style.display = 'block';
            let s = 120;
            let t = setInterval(() => {
                s--; document.getElementById('time-left').innerText = s;
                if(s<=0){ clearInterval(t); luckMult = oldLuck; godMode = false; document.getElementById('god-timer').style.display='none'; }
            }, 1000);
        }
        document.getElementById('code-in').value = ""; save(); updateUI();
    }

    function toggleModal() {
        const m = document.getElementById('modal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        if(m.style.display === 'flex') {
            const grid = document.getElementById('catalog-grid'); grid.innerHTML = "";
            TODOS.forEach(w => {
                if(discovered[w.id]) {
                    const d = document.createElement('div');
                    d.style.cssText = `border:1px solid ${w.color}; padding:5px; text-align:center; font-size:0.25rem; background:#111; border-radius:5px;`;
                    d.innerHTML = `${getWormSVG(w)}<br>${w.nombre}<br>x${inventory[w.id]}`;
                    d.onclick = () => {
                        let empty = bases.findIndex(b => b === null);
                        if(empty !== -1 && inventory[w.id] > 0) { inventory[w.id]--; bases[empty] = w; updateBasesUI(); toggleModal(); save(); }
                    };
                    grid.appendChild(d);
                }
            });
        }
    }

    function removeWorm(idx) { if(bases[idx]) { inventory[bases[idx].id]++; bases[idx] = null; updateBasesUI(); save(); } }

    function updateBasesUI() {
        let total = 0;
        bases.forEach((w, i) => {
            const s = document.getElementById(`slot-${i}`);
            if(w) { s.innerHTML = `${getWormSVG(w)}<span style="color:${w.color}; font-size:0.3rem;">+${w.income}/s</span>`; total += w.income; }
            else { s.innerHTML = "[EMPTY]"; }
        });
        document.getElementById('mps').innerText = total;
    }

    function updateUI() {
        document.getElementById('coins').innerText = Math.floor(coins);
        document.getElementById('speed-val').innerText = (rollSpeed/1000).toFixed(1);
        document.getElementById('luck-val').innerText = luckMult.toFixed(1);
        document.getElementById('speed-cost').innerText = Math.floor(speedCost);
        document.getElementById('luck-cost').innerText = Math.floor(luckCost);
    }

    setInterval(() => {
        let gain = 0; bases.forEach(w => { if(w) gain += w.income; });
        if(gain > 0) { coins += gain; updateUI(); save(); }
    }, 1000);

    updateUI();
</script>
</body>
</html>
