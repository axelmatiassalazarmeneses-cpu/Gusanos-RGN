<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Worm RNG: Rebirth Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --comun: #7f8c8d; --raro: #00d2ff; --epico: #a29bfe; 
            --legendario: #ffeaa7; --mitico: #ff7675; --secreto: #6c5ce7;
            --neon: #00ffcc; --dark: #0a0a0b; --gold: #f1c40f;
        }

        body { 
            background: var(--dark); color: white; font-family: 'Press Start 2P', cursive;
            margin: 0; padding: 0; overflow: hidden; height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        .grid-bg {
            position: fixed; inset: 0; z-index: -1;
            background: linear-gradient(transparent 0%, rgba(0, 255, 204, 0.05) 50%, transparent 100%),
                        linear-gradient(90deg, transparent 0%, rgba(0, 255, 204, 0.05) 50%, transparent 100%);
            background-size: 40px 40px;
        }

        #start-screen {
            position: fixed; inset: 0; z-index: 9999; background: #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .game-container {
            width: 90%; max-width: 400px; padding: 15px;
            background: rgba(10, 10, 11, 0.9); border: 2px solid #222;
            border-radius: 20px; margin-top: 10px; position: relative;
        }

        .stat-bar {
            display: flex; flex-direction: column; gap: 5px; font-size: 0.45rem;
            background: #000; padding: 10px; border-radius: 10px; border: 1px solid #333;
            margin-bottom: 10px; color: var(--neon);
        }

        .roulette-wrapper {
            position: relative; width: 100%; height: 130px; background: #000;
            border: 2px solid #333; overflow: hidden; margin: 10px 0; border-radius: 10px;
        }
        .marker { position: absolute; left: 50%; top: 0; bottom: 0; width: 4px; background: var(--neon); z-index: 10; transform: translateX(-50%); box-shadow: 0 0 10px var(--neon); }
        #roulette-strip { display: flex; position: absolute; left: 0; top: 0; height: 100%; will-change: transform; }
        .item { min-width: 120px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.35rem; }

        .btn-roll { width: 100%; padding: 15px; background: var(--neon); color: #000; font-family: 'Press Start 2P'; font-size: 0.8rem; border: none; border-radius: 10px; cursor: pointer; margin-bottom: 10px; }
        .btn-roll:disabled { background: #333; color: #666; }

        .upgrade-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .card { background: #151517; border: 1px solid #333; padding: 10px; border-radius: 10px; text-align: center; font-size: 0.35rem; cursor: pointer; }

        /* BOTON REBIRTH */
        .btn-rebirth {
            width: 100%; padding: 12px; background: #000; border: 2px solid var(--gold);
            color: var(--gold); font-family: 'Press Start 2P'; font-size: 0.5rem;
            border-radius: 10px; cursor: pointer; margin-top: 5px; transition: 0.3s;
        }
        .btn-rebirth:hover { background: var(--gold); color: #000; }
        .btn-rebirth:disabled { border-color: #333; color: #333; cursor: not-allowed; }

        .worm-svg { width: 60px; height: 30px; }
        .base-slot { background: #000; border: 2px dashed #333; height: 60px; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 0.3rem; flex: 1; }
        
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9000; display: none; flex-direction: column; padding: 20px; }
    </style>
</head>
<body>

    <div class="grid-bg"></div>
    <div id="start-screen" onclick="startGame()" style="cursor:pointer">
        <h1 style="color:var(--neon); font-size: 1.2rem;">WORM RNG</h1>
        <p style="font-size: 0.5rem; color: #555;">[ TAP TO START ]</p>
    </div>

    <div class="game-container">
        <div id="god-timer" style="display:none; color:gold; font-size:0.4rem; text-align:center; margin-bottom:5px;">GOD MODE ACTIVE</div>
        
        <div class="stat-bar">
            <div style="display:flex; justify-content:space-between">
                <span>CREDITS: <span id="coins" style="color:white">100</span></span>
                <span>DATA: <span id="mps">0</span>/s</span>
            </div>
            <div style="font-size: 0.35rem; color: var(--gold); border-top: 1px solid #222; pt: 5px;">
                REBIRTHS: <span id="rebirth-count">0</span> (x<span id="rebirth-mult">1.0</span> Boost)
            </div>
        </div>

        <div class="roulette-wrapper">
            <div class="marker"></div>
            <div id="roulette-strip"></div>
        </div>

        <button class="btn-roll" id="roll-btn" onclick="startRoll()">ROLL (-10)</button>

        <div class="upgrade-grid">
            <div class="card" onclick="upgradeSpeed()">
                SPEED: <span id="speed-val">3.0</span>s
                <div style="color:gold; margin-top:5px;" id="speed-cost">100</div>
            </div>
            <div class="card" onclick="upgradeLuck()">
                LUCK: x<span id="luck-val">1.0</span>
                <div style="color:gold; margin-top:5px;" id="luck-cost">1000</div>
            </div>
        </div>

        <button class="btn-rebirth" id="rebirth-btn" onclick="performRebirth()">
            NEURAL REBIRTH<br>
            COST: <span id="rebirth-cost">30000</span>
        </button>

        <div style="display:flex; gap:5px; margin-top:10px;">
            <div class="base-slot" id="slot-0" onclick="removeWorm(0)">EMPTY</div>
            <div class="base-slot" id="slot-1" onclick="removeWorm(1)">EMPTY</div>
            <div class="base-slot" id="slot-2" onclick="removeWorm(2)">EMPTY</div>
        </div>
        
        <div style="text-align:center; margin-top:10px;">
            <span onclick="toggleModal()" style="font-size:0.4rem; color:var(--neon); cursor:pointer;">[ OPEN DATABASE ]</span>
        </div>
    </div>

    <div id="modal">
        <div style="text-align:right; color:red; margin-bottom:20px;" onclick="toggleModal()">[CERRAR]</div>
        <div id="catalog-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; overflow-y:auto;"></div>
    </div>

<script>
    const RAREZAS = {
        COMUN: { color: "#7f8c8d", mult: 1, nombres: ["Tierra", "Lodo", "Pasto"] },
        RARO: { color: "#00d2ff", mult: 4, nombres: ["Neon", "Fuego", "Acido"] },
        EPICO: { color: "#a29bfe", mult: 15, nombres: ["Aura", "Nebula", "Plasma"] },
        LEGENDARIO: { color: "#ffeaa7", mult: 60, nombres: ["Oro", "Solar", "Gema"] },
        MITICO: { color: "#ff7675", mult: 200, nombres: ["Vacio", "Caos"] },
        SECRETO: { color: "#6c5ce7", mult: 1000, nombres: ["Putolauate"] }
    };

    let TODOS = [];
    Object.keys(RAREZAS).forEach(rar => {
        RAREZAS[rar].nombres.forEach(nom => {
            TODOS.push({ nombre: nom, rareza: rar, color: RAREZAS[rar].color, income: RAREZAS[rar].mult, id: TODOS.length });
        });
    });

    // --- VARIABLES DE ESTADO ---
    let coins = 100, inventory = {}, discovered = {}, bases = [null, null, null];
    let rollSpeed = 3000, speedCost = 100, luckMult = 1, luckCost = 1000;
    let rebirths = 0, rebirthCost = 30000;
    let godMode = false;

    function save() {
        const data = { coins, inventory, discovered, rollSpeed, speedCost, luckMult, luckCost, rebirths, rebirthCost, basesIds: bases.map(b => b?b.id:null) };
        localStorage.setItem('worm_data_rebirth', JSON.stringify(data));
    }

    function load() {
        const saved = localStorage.getItem('worm_data_rebirth');
        if(saved) {
            const d = JSON.parse(saved);
            coins = d.coins; inventory = d.inventory; discovered = d.discovered;
            rollSpeed = d.rollSpeed; speedCost = d.speedCost; luckMult = d.luckMult; luckCost = d.luckCost;
            rebirths = d.rebirths || 0; rebirthCost = d.rebirthCost || 30000;
            if(d.basesIds) bases = d.basesIds.map(id => id !== null ? TODOS.find(w => w.id === id) : null);
        }
        updateUI(); updateBasesUI();
    }

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        load();
    }

    // --- LÓGICA DE REBIRTH ---
    function performRebirth() {
        if(coins >= rebirthCost) {
            if(confirm("¿Quieres renacer? Perderás tus monedas, inventario y mejoras, pero ganarás +0.2x de multiplicador permanente.")) {
                rebirths++;
                rebirthCost = Math.floor(rebirthCost * 2.5);
                
                // Reset de progreso
                coins = 100;
                inventory = {};
                bases = [null, null, null];
                rollSpeed = 3000;
                speedCost = 100;
                luckMult = 1;
                luckCost = 1000;
                
                save();
                updateUI();
                updateBasesUI();
                
                // Efecto visual
                document.body.style.filter = "invert(1)";
                setTimeout(() => document.body.style.filter = "none", 500);
            }
        }
    }

    function getWormSVG(worm) {
        const c = worm.color;
        return `<svg class="worm-svg" viewBox="0 0 80 40">
            <path d="M10,25 Q25,10 40,25 T70,25" stroke="${c}" stroke-width="6" fill="none" stroke-linecap="round" />
            <circle cx="70" cy="22" r="2" fill="white" />
        </svg>`;
    }

    function startRoll() {
        if(coins < 10) return;
        coins -= 10; updateUI();
        const btn = document.getElementById('roll-btn');
        const strip = document.getElementById('roulette-strip');
        btn.disabled = true;
        const count = 30, winnerIdx = 25, itemWidth = 120;
        strip.style.transition = 'none'; strip.style.transform = 'translateX(0)';
        let html = ""; let pool = [];
        for(let i=0; i<count; i++) {
            let w = getRNGWorm(); pool.push(w);
            html += `<div class="item">${getWormSVG(w)}<b style="color:${w.color}">${w.nombre}</b></div>`;
        }
        strip.innerHTML = html;
        setTimeout(() => {
            const offset = -(winnerIdx * itemWidth) + (strip.parentElement.offsetWidth / 2) - (itemWidth / 2);
            strip.style.transition = `transform ${rollSpeed}ms cubic-bezier(0.15, 0, 0.15, 1)`;
            strip.style.transform = `translateX(${offset}px)`;
            setTimeout(() => { finalizarRoll(pool[winnerIdx]); btn.disabled = false; }, rollSpeed);
        }, 50);
    }

    function getRNGWorm() {
        const r = Math.random() * 100 * (1/luckMult);
        if(r < 0.1) return getRandomByRareza("SECRETO");
        if(r < 0.8) return getRandomByRareza("MITICO");
        if(r < 4) return getRandomByRareza("LEGENDARIO");
        if(r < 15) return getRandomByRareza("EPICO");
        if(r < 40) return getRandomByRareza("RARO");
        return getRandomByRareza("COMUN");
    }

    function getRandomByRareza(rar) {
        let p = TODOS.filter(w => w.rareza === rar);
        return p[Math.floor(Math.random() * p.length)];
    }

    function finalizarRoll(worm) {
        discovered[worm.id] = true;
        inventory[worm.id] = (inventory[worm.id] || 0) + 1;
        save(); updateUI();
    }

    function upgradeSpeed() { if(coins >= speedCost) { coins -= speedCost; rollSpeed = Math.max(400, rollSpeed - 300); speedCost *= 2; save(); updateUI(); } }
    function upgradeLuck() { if(coins >= luckCost) { coins -= luckCost; luckMult += 0.5; luckCost *= 2; save(); updateUI(); } }

    function updateBasesUI() {
        let total = 0;
        let rMult = 1 + (rebirths * 0.2);
        bases.forEach((w, i) => {
            const s = document.getElementById(`slot-${i}`);
            if(w) { 
                let inc = (w.income * rMult).toFixed(1);
                s.innerHTML = `${getWormSVG(w)}<span style="color:${w.color}; font-size:0.3rem;">+${inc}/s</span>`; 
                total += w.income * rMult; 
            }
            else { s.innerHTML = "EMPTY"; }
        });
        document.getElementById('mps').innerText = total.toFixed(1);
    }

    function updateUI() {
        let rMult = 1 + (rebirths * 0.2);
        document.getElementById('coins').innerText = Math.floor(coins);
        document.getElementById('speed-val').innerText = (rollSpeed/1000).toFixed(1);
        document.getElementById('luck-val').innerText = luckMult.toFixed(1);
        document.getElementById('speed-cost').innerText = Math.floor(speedCost);
        document.getElementById('luck-cost').innerText = Math.floor(luckCost);
        
        document.getElementById('rebirth-count').innerText = rebirths;
        document.getElementById('rebirth-mult').innerText = rMult.toFixed(1);
        document.getElementById('rebirth-cost').innerText = rebirthCost;
        
        document.getElementById('rebirth-btn').disabled = (coins < rebirthCost);
    }

    function toggleModal() {
        const m = document.getElementById('modal');
        m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
        if(m.style.display === 'flex') {
            const grid = document.getElementById('catalog-grid'); grid.innerHTML = "";
            TODOS.forEach(w => {
                if(discovered[w.id]) {
                    const d = document.createElement('div');
                    d.style.cssText = `border:1px solid ${w.color}; padding:5px; text-align:center; font-size:0.25rem; background:#111;`;
                    d.innerHTML = `${getWormSVG(w)}<br>${w.nombre}<br>x${inventory[w.id]}`;
                    d.onclick = () => {
                        let empty = bases.findIndex(b => b === null);
                        if(empty !== -1 && inventory[w.id] > 0) { inventory[w.id]--; bases[empty] = w; updateBasesUI(); toggleModal(); save(); }
                    };
                    grid.appendChild(d);
                }
            });
        }
    }

    function removeWorm(idx) { if(bases[idx]) { inventory[bases[idx].id]++; bases[idx] = null; updateBasesUI(); save(); } }

    setInterval(() => {
        let rMult = 1 + (rebirths * 0.2);
        let gain = 0; 
        bases.forEach(w => { if(w) gain += w.income * rMult; });
        if(gain > 0) { coins += gain; updateUI(); save(); }
    }, 1000);

</script>
</body>
</html>
